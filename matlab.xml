<!-- vi: se ft=ant: -->

<project name="fr.cea.ant.lib.matlab">

	<include file="system.xml" as="system"/>

	<!-- MATLAB COMMAND -->
	<condition property="matlab-cmd-arg-display" value="-nosplash">
		<isset property="isWindows"/>
	</condition>
	<condition property="matlab-cmd-arg-wait" value="-wait">
		<isset property="isWindows"/>
	</condition>
	<property name="matlab-cmd-arg-display" value="-nodisplay"/>
	<property name="matlab-cmd-arg-wait" value=""/>
	<property name="matlab-cmd-arg-run" value="-r"/>

	<!-- EXEC MATLAB FUNCTION -->
	<macrodef name="matlab">
		<attribute name="fct"/>
		<attribute name="dir" default="."/>
		<sequential>
			<!-- Display matlab command -->
			<echo message="Execute matlab inside directory @{dir}:"/>
			<echo message="matlab ${matlab-cmd-arg-display} ${matlab-cmd-arg-wait} ${matlab-cmd-arg-run} '@{fct};quit'"/>

			<!-- TODO Check that error canal works on Windows. Otherwise use output canal. -->
			<exec executable="matlab" dir="@{dir}" errorproperty="matlab.err" failonerror="true">
				<arg value="${matlab-cmd-arg-display}"/>
				<arg value="${matlab-cmd-arg-wait}"/>
				<arg value="${matlab-cmd-arg-run}"/>
				<arg value="@{fct};quit"/>
			</exec>

			<!-- Display error messages -->
			<concat>${matlab.err}<filterchain>
					<tokenfilter>
						<!-- Add .m extension to filenames for vi or emacs editors. -->
						<replaceregex pattern="(Error in .*) \(" replace="\1.m (" flags="gi"/>
					</tokenfilter>
				</filterchain>
			</concat>
			
			<!-- Fails if error detected in matlab messages -->
			<fail>
				<condition>
					<contains string="${matlab.err}" substring="Error"/>
				</condition>
			</fail>
		</sequential>
	</macrodef>

</project>
